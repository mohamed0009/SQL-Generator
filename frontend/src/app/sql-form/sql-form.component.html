<div class="container" @cardAnimation>
  <div class="card">
    <form [formGroup]="sqlForm" (ngSubmit)="onSubmit()">
      <mat-form-field appearance="outline" class="form-group">
        <mat-label>Table Name</mat-label>
        <input
          matInput
          formControlName="tableName"
          required
          placeholder="Enter table name"
        />
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-group">
        <mat-label>SQL Dialect</mat-label>
        <mat-select formControlName="dialect" required>
          <mat-option value="MySQL">MySQL</mat-option>
          <mat-option value="PostgreSQL">PostgreSQL</mat-option>
          <mat-option value="SQLite">SQLite</mat-option>
          <mat-option value="SQL Server">SQL Server</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="template-buttons">
        <button mat-stroked-button (click)="addTemplateColumn('id')">
          <mat-icon>key</mat-icon>
          Add ID
        </button>
        <button mat-stroked-button (click)="addTemplateColumn('timestamp')">
          <mat-icon>schedule</mat-icon>
          Add Timestamp
        </button>
        <button mat-stroked-button (click)="addTemplateColumn('foreignKey')">
          <mat-icon>link</mat-icon>
          Add Foreign Key
        </button>
      </div>

      <div formArrayName="columns" class="column-section" @listAnimation>
        <h3>Columns</h3>

        <ng-container
          *ngFor="let column of columns.controls; let $index = index"
        >
          <div [formGroupName]="$index" class="column-form" [@columnAnimation]>
            <div class="column-header">
              <h4>Column {{ $index + 1 }}</h4>
              <button
                mat-icon-button
                color="warn"
                (click)="removeColumn($index)"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>

            <mat-form-field appearance="outline">
              <mat-label>Column Name</mat-label>
              <input matInput formControlName="name" required />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Type</mat-label>
              <mat-select formControlName="type" required>
                <mat-option value="entier">Integer</mat-option>
                <mat-option value="texte">Text</mat-option>
                <mat-option value="date">Date</mat-option>
              </mat-select>
            </mat-form-field>

            <div class="checkbox-group">
              <mat-checkbox formControlName="primaryKey"
                >Primary Key</mat-checkbox
              >
              <mat-checkbox formControlName="autoIncrement"
                >Auto Increment</mat-checkbox
              >
              <mat-checkbox formControlName="required">Required</mat-checkbox>
              <mat-checkbox formControlName="unique">Unique</mat-checkbox>
            </div>

            <mat-form-field appearance="outline">
              <mat-label>References (table.column)</mat-label>
              <input
                matInput
                formControlName="reference"
                placeholder="tablename.columnname"
              />
            </mat-form-field>
          </div>
        </ng-container>
      </div>

      <div class="button-group">
        <div class="left-buttons">
          <input
            type="file"
            #fileInput
            accept=".json"
            (change)="importJson($event)"
            hidden
          />
          <button mat-stroked-button (click)="fileInput.click()">
            <mat-icon>upload</mat-icon>
            Import JSON
          </button>
          <button
            mat-stroked-button
            [disabled]="!sqlForm.valid || columns.length === 0"
            (click)="exportJson()"
          >
            <mat-icon>download</mat-icon>
            Export JSON
          </button>
          <button
            mat-stroked-button
            [disabled]="!generatedSQL"
            (click)="exportSql()"
          >
            <mat-icon>code</mat-icon>
            Export SQL
          </button>
        </div>

        <div class="right-buttons">
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="addColumn()"
          >
            <mat-icon>add</mat-icon>
            Add Column
          </button>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="!sqlForm.valid || columns.length === 0 || isLoading"
          >
            <ng-container *ngIf="isLoading; else generateButton">
              <mat-spinner diameter="20"></mat-spinner>
            </ng-container>
            <ng-template #generateButton>
              <mat-icon>play_arrow</mat-icon>
              <span>Generate SQL</span>
            </ng-template>
          </button>
        </div>
      </div>

      <ng-container *ngIf="columns.length === 0">
        <mat-card class="alert warning">
          <mat-icon>warning</mat-icon>
          Please add at least one column
        </mat-card>
      </ng-container>
    </form>
  </div>

  <app-sql-output *ngIf="generatedSQL" [sql]="generatedSQL"></app-sql-output>
</div>
